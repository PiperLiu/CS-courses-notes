# LEC 19: Peer-to-peer: Bitcoin

<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [NotebookLM 生成的双人播客](#notebooklm-生成的双人播客)
- [Gemini 2.5 Pro 生成的“比特币”](#gemini-25-pro-生成的比特币)
  - [为什么我们需要比特币？](#为什么我们需要比特币)
  - [核心思想：一条数字签名的链条](#核心思想一条数字签名的链条)
  - [核心难题：双重支付（Double-Spending）](#核心难题双重支付double-spending)
  - [解决方案：公共账本与工作量证明](#解决方案公共账本与工作量证明)
    - [公共账本：区块链（Blockchain）](#公共账本区块链blockchain)
    - [共识机制：工作量证明（Proof-of-Work）](#共识机制工作量证明proof-of-work)
  - [系统协同工作](#系统协同工作)
    - [关于分叉（Fork）](#关于分叉fork)
  - [安全、激励与常见问题](#安全-激励与常见问题)
    - [51% 攻击](#51-攻击)
    - [激励机制](#激励机制)
    - [为什么是 10 分钟？](#为什么是-10-分钟)
  - [隐私是匿名的吗？](#隐私是匿名的吗)
  - [结论](#结论)
  - [一些问题](#一些问题)
    - [“账本”存储在哪里？交易数量太多，如何管理容量？](#账本存储在哪里交易数量太多如何管理容量)
    - [所有交易都需要经历“挖矿”才能落入帐本吗？如果某段时间交易量非常大该怎么办？](#所有交易都需要经历挖矿才能落入帐本吗如果某段时间交易量非常大该怎么办)
    - [据说现在已经“挖完了”，是这样吗？如果已经挖完了，那还如何保证新交易的正确性呢？](#据说现在已经挖完了是这样吗如果已经挖完了那还如何保证新交易的正确性呢)

<!-- /code_chunk_output -->

## NotebookLM 生成的双人播客

https://notebooklm.google.com/notebook/c0a6a181-fed2-472c-b696-8f9ed4508fad/audio

微信链接： https://mp.weixin.qq.com/s/m1QbhcesR_09GAQvWWTLhw

给我留下的较深的印象：
1. 为了去中心化这个特性，付出的代价是不小的：用计算量防止女巫攻击，同时区块链又要记录并公开全部交易记录，破坏了隐私性
2. 实际的比特币交易一定比这复杂，文末也提到了，不会每一次小交易都需要去“挖矿”确认

## Gemini 2.5 Pro 生成的“比特币”

### 为什么我们需要比特币？

在互联网时代，我们的在线交易几乎完全依赖于银行、支付宝等金融机构作为可信第三方。这个模式虽然在大多数情况下运行良好，但它有其固有的“基于信任”的弱点。

首先， **交易并非不可逆** 。金融机构需要仲裁纠纷，这意味着你的付款随时可能被撤销。为了应对这种风险，商家需要承担额外的成本，比如处理欺诈的费用、要求用户提供更多个人信息等。这无形中增加了交易的门槛，尤其对于小额支付来说很不划算。

其次， **信任是存在风险的** 。你需要相信这些机构不会滥用你的数据，不会无故冻结你的资产。

比特币的目标，就是创建一个基于 **密码学证明（cryptographic proof）** 而非信任的电子支付系统，让任意两方能够直接交易，而无需一个中心化的第三方机构。这其中的核心技术挑战有两个：

1.  **防止伪造** ：这个问题相对容易解决。
2.  **防止双花（double-spending）** ：这是最核心、最困难的问题，也是比特币设计精髓所在。

### 核心思想：一条数字签名的链条

让我们从最基础的交易概念开始。在比特币的世界里，并没有一个实体“硬币”的存在。一个所谓的 **电子币（electronic coin）** ，其实是一条由 **数字签名（digital signatures）** 组成的链。

一笔交易的本质是，当前的所有者（比如 Alice）将一枚（或一部分）电子币的所有权转移给下一个所有者（比如 Bob）。她通过用自己的 **私钥（private key）** 对“上一笔交易的哈希值”和“Bob 的公钥”这两项信息进行签名来完成这个过程。

```txt
  +------------------+      +------------------+      +------------------+
  |   Transaction_0  |      |   Transaction_1  |      |   Transaction_2  |
  |------------------|      |------------------|      |------------------|
  | Owner_1's PubKey |----->| Owner_2's PubKey |----->| Owner_3's PubKey |
  |      ...         |      | Hash(Trans_0)    |      | Hash(Trans_1)    |
  | Hash(...)        |      | Sig_by_Owner_1   |      | Sig_by_Owner_2   |
  +------------------+      +------------------+      +------------------+
```

Bob 在收到这笔交易后，可以使用 Alice 的 **公钥（public key）** 来验证这个签名，从而确认 Alice 确实是这枚币的前任主人，并且同意将它转让给自己。这个过程不断重复，就形成了一条清晰的所有权链。

但很快，我们就遇到了那个核心问题。

### 核心难题：双重支付（Double-Spending）

如果 Alice 是个不诚实的人，她完全可以把 **同一枚币** 同时发给两个人。她可以创建一笔交易“付给 Bob”，再创建另一笔交易“付给 Charlie”，这两笔交易都引用了同一个上一笔交易，并且都用了 Alice 自己的有效签名。

对 Bob 来说，他收到的交易是合法的。对 Charlie 来说，他收到的交易也同样合法。他们俩都不知道对方的存在，因为没有一个全局的视角来告诉他们所有交易的完整顺序。这就是 **双花** 问题。

传统的解决方案是引入一个中心化的权威机构，比如银行或者“铸币厂（mint）”，由它来记录所有交易，并以它收到的顺序为准。但这就又回到了我们最初想要摆脱的“基于信任”的模型。

比特币需要一种去中心化的方式，让网络中的所有参与者对交易的发生顺序达成一个共识。

### 解决方案：公共账本与工作量证明

比特币的解决方案非常巧妙，它由两个关键部分组成：一个公开的交易账本，以及一种达成共识的机制。

#### 公共账本：区块链（Blockchain）

为了防止双花，所有的交易都必须被公开广播。比特币将这些交易打包成一个个的 **区块（block）** ，然后将这些区块按时间顺序链接起来，形成一个 **区块链（blockchain）** 。

这个链条之所以难以篡改，是因为每个区块都包含了前一个区块内容的 **哈希值（hash）** 。如果你试图修改历史中的某个区块（比如删除一笔你已经支付出去的交易），那么这个区块的哈希值就会改变。由于下一个区块包含了前一个区块的哈希，它的内容也必须随之改变，接着是下下个区块……以此类推，你需要重做自那个点之后的所有区块。

这样，区块链就成了一个公开、透明且难以篡改的全局总账本。只要我们能确保所有人都使用同一个版本的账本，双花问题就解决了。

#### 共识机制：工作量证明（Proof-of-Work）

现在的问题是，在一个去中心化、人人皆可参与的网络中，由谁来记账（即创建新的区块）？我们又如何相信他记的账是诚实的呢？

一个简单的想法是投票。但这种方式在开放网络中行不通，因为它无法抵御 **女巫攻击（Sybil Attack）** 。攻击者可以轻易地伪造出成千上万个虚假身份（IP 地址或账户），让自己看起来像是网络中的“多数派”，从而控制记账权。

比特币的创举在于引入了 **工作量证明（Proof-of-Work, PoW）** 机制。它的核心思想是：投票权不应基于身份，而应基于真实的计算能力（CPU power）。这相当于“一 CPU 一票”。

具体来说，网络中的参与者（被称为 **矿工, `miner`** ）会竞争一个记账权。竞争的方式是解决一个数学难题：他们需要不断尝试不同的随机数（称为 `nonce`），并将其与区块里的其他数据（交易记录、前一区块的哈希等）一起进行哈希运算，直到计算出的哈希值小于一个特定的目标值（比如，哈希结果的前 N 位都是 0）。

这个过程有几个关键特点：

* **困难但可验证** ：找到一个有效的 `nonce` 非常困难，需要巨大的计算量，就像中彩票一样。但一旦有人找到了，其他人验证它是否正确却非常容易，只需进行一次哈希运算即可。
* **难度动态调整** ：比特币网络会根据全体矿工的总算力，自动调整这个数学题的难度，以确保平均每 **10 分钟** 左右就有一个新的区块被“挖”出来。无论有多少人加入或退出挖矿，这个出块时间都会保持稳定。

第一个成功解出难题的矿工，就赢得了记账权。他会将自己打包好的区块广播给全网所有节点。

### 系统协同工作

现在我们把所有部分串联起来，看看比特币网络是如何运作的：

1.  **交易广播** ：当你发起一笔交易时，它会被广播到网络中的所有节点。
2.  **区块打包** ：矿工们收集这些待确认的交易，并将它们打包进一个候选区块。
3.  **挖矿** ：矿工们开始进行工作量证明计算，争夺记账权。
4.  **区块广播与验证** ：某个矿工率先找到正确的 `nonce`，他立刻将这个新区块广播出去。
5.  **共识达成** ：其他节点收到新区块后，会进行验证：
  * 区块的哈希值是否符合难度要求？
  * 区块中包含的所有交易是否都合法（例如，签名有效、没有双花）？
  * 区块是否正确地指向了前一个区块？
  * 验证通过后，节点们会接受这个新区块，并把它加到自己的区块链末端。然后，他们会基于这个新区块的哈希，开始竞争下一个区块的记账权。

这个过程的关键在于 **最长链原则** 。节点永远承认并沿着最长的那条区块链继续工作。这就是比特币的共识规则。因为最长的链代表了最大的工作量证明投入，也即是最多算力的选择。

#### 关于分叉（Fork）

一个常见的问题是：如果两个矿工几乎同时找到了有效区块怎么办？

这时，网络中会暂时出现一个 **分叉（fork）** ，一部分节点收到了矿工 A 的区块，另一部分收到了矿工 B 的。大家会各自在自己收到的那条链上继续挖矿。

不过，这个分叉通常是暂时的。由于挖矿的随机性，很快就会有一条链比另一条链先被延长，变得更长。根据“最长链原则”，之前在较短链上工作的矿工会立刻放弃自己的工作，转换到更长的链上。这样，共识很快就会恢复，其中一条分叉链会被抛弃。

被抛弃分叉链中的交易（如果没被包含在主链中）会重新回到待确认的交易池里，等待下一次被打包。

这就是为什么对于大额交易，通常建议等待几个区块（即所谓的“ **确认数** ”）之后再认为交易是最终完成的。因为一个区块后面连接的后续区块越多，它被另一条更长的分叉链取代的可能性就越呈指数级下降。

### 安全、激励与常见问题

#### 51% 攻击

比特币的安全性依赖于一个基本假设： **诚实的节点控制着网络中绝大多数（>50%）的算力** 。

如果一个攻击者（或一个实体）控制了超过 50% 的算力，他就能发动 **51% 攻击** 。他可以秘密地在旧区块之后建立一个自己的分叉链，并在上面进行双花（比如，把已经付给商家的币再付给自己）。由于他有算力优势，他的私有链最终会超过主链的长度，然后他再把这条链广播出去。根据最长链原则，全网都会接受他的这条链，从而导致他之前的支付被“撤销”。

需要注意的是，即使发动 51% 攻击，攻击者也 **不能** ：

* 凭空创造比特币。
* 窃取不属于他的比特币（因为他没有别人的私钥）。

这种攻击在理论上是可能的，而且由于算力越来越集中于少数几个大型 **矿池（mining pools）** ，这种担忧并非空穴来风。

#### 激励机制

为什么会有人愿意花费大量的电力和计算资源来挖矿，维护网络的安全呢？答案是激励。

1.  **区块奖励** ：作为对他们工作的回报，成功挖出新区块的矿工会获得一笔新创造的比特币作为奖励。这是比特币发行的唯一方式。
2.  **交易费** ：用户在发起交易时，可以自愿附加一笔 **交易费（transaction fee）** 。这笔费用同样会归打包该交易的矿工所有。矿工通常会优先选择打包手续费高的交易。

这种激励机制精妙地将个人利益与网络整体安全绑定在了一起。对于一个掌握了大量算力的矿工来说，诚实地挖矿获取奖励，通常比冒着破坏整个系统信誉的风险去发动攻击更有利可图。

#### 为什么是 10 分钟？

10 分钟的确认时间对很多应用场景来说确实很长。这个时间的设定是一个权衡。它必须远大于一个新区块在整个网络中传播所需的时间。如果这个时间太短（比如 10 秒），那么由于网络延迟，分叉会频繁发生，导致网络共识不稳定，并浪费大量算力。

对于小额支付，比如买杯咖啡，商家可以不必等待区块确认，只需确认这笔交易已经被网络中的一些节点接收且看起来合法即可，这种风险是可以接受的。

### 隐私是匿名的吗？

这是一个常见的误解。比特币是 **假名（pseudonymous）** 的，而非 **匿名（anonymous）** 的。

你的身份与你的公钥（即比特币地址）没有直接关联。但是，所有的交易记录都在区块链上完全公开。任何人都可以看到哪个地址给哪个地址转了多少钱。如果你的某个地址一旦与你的真实身份相关联（比如你从一个需要实名认证的交易所提币到这个地址），那么通过分析区块链，别人就有可能追踪到你所有的其他交易。

### 结论

比特币通过一个巧妙的设计，解决了在没有中心化信任机构的情况下进行电子现金交易的难题。

它将数字签名、点对点网络、以及创新的工作量证明机制结合在一起，创造了一个公开、去中心化且难以篡改的全球账本——区块链。它的核心思想——通过去中心化的共识机制（投票权与算力挂钩）来维护一个统一的、可信的数据记录——具有革命性的意义，其影响早已超出了数字货币本身。

### 一些问题

#### “账本”存储在哪里？交易数量太多，如何管理容量？

**账本存储在哪里？**

比特币的“账本”实际上就是 **区块链（blockchain）** ，它记录了所有比特币交易的历史。区块链并不是存储在某个中心化的服务器上，而是分布在比特币网络中的每一个 **全节点（full node）** 上。全节点是指运行比特币软件并保存完整区块链副本的计算机。这些节点遍布全球，由个人、公司或组织自愿运行，共同维护比特币的去中心化特性。

简单来说：
- 每个全节点都有一份完整的账本副本。
- 当您运行一个全节点时，您的计算机会下载并存储整个区块链数据（截至2025年，数据大小已超过数百GB）。
- 这种分布式存储方式确保了账本不会因为单一故障点（如某个服务器宕机）而丢失。

**交易数量太多，如何管理容量？**

比特币区块链的容量确实有限，每个区块的最大大小目前为 **4MB** （考虑隔离见证后的有效容量），并且平均每 **10分钟** 产生一个新区块。这意味着比特币网络每秒只能处理大约 **7笔交易** ，远低于传统金融系统（如Visa每秒可处理数千笔交易）。

当交易数量增加时，会出现以下情况：
- **交易积压** ：交易等待被打包进区块的时间变长。
- **容量管理方案** ：比特币社区提出了多种解决方案来应对这一问题：
  1. **隔离见证（SegWit）**
     通过优化交易数据的存储方式（将签名数据分离），提高了每个区块的实际容量，而无需直接增加区块大小。这已在2017年激活。
  2. **闪电网络（Lightning Network）**
     这是一种 **第二层（Layer 2）** 解决方案，允许用户在区块链之外进行快速、低成本的交易。只有在需要最终结算时，才将结果记录到主链上。这大大减轻了主链的负担，适用于小额、高频交易。
  3. **区块大小调整**
     社区曾讨论过直接增加区块大小（如比特币现金分叉将区块大小提升至32MB），但这需要网络共识，且存在争议，因为更大的区块会增加全节点的存储和带宽需求，可能削弱去中心化。

因此，比特币通过技术优化和扩展方案，逐步解决容量问题，同时保持去中心化的核心原则。

#### 所有交易都需要经历“挖矿”才能落入帐本吗？如果某段时间交易量非常大该怎么办？

**所有交易都需要经历“挖矿”才能落入帐本吗？**

是的，在比特币系统中，所有交易都必须通过 **挖矿** 被包含在一个区块中，并记录到区块链上，才算正式落入账本。过程如下：
- 用户发起交易后，交易被广播到网络。
- 矿工收集这些交易，打包成一个 **候选区块** 。
- 矿工通过 **工作量证明（Proof-of-Work）** 解决数学难题，成功后将区块添加到区块链。
- 只有被添加到区块链的交易才被视为“已确认”。

未经挖矿确认的交易仅停留在 **交易池（mempool）** 中，属于待处理状态，无法保证其有效性。

**如果某段时间交易量非常大该怎么办？**

当交易量激增时，可能会超过网络的处理能力，导致以下情况：
- **交易积压** ：交易池中的待确认交易数量增加，等待时间变长。
- **解决办法** ：
  1. **提高交易费**
     用户可以选择支付更高的 **交易费（transaction fee）** ，以激励矿工优先打包他们的交易。矿工会根据手续费高低排序，优先处理费用更高的交易。
  2. **使用第二层解决方案**
     如前所述， **闪电网络** 可以在链下处理大量交易，仅在必要时将结果上链，从而缓解主链压力。
  3. **等待确认**
     如果不急于确认，低费用交易可能需要等待更长时间，直到交易量减少或矿工处理能力跟上。

因此，比特币通过灵活的交易费机制和链下扩展技术，能够在交易量高峰时维持运行，但用户可能需要权衡速度与成本。

#### 据说现在已经“挖完了”，是这样吗？如果已经挖完了，那还如何保证新交易的正确性呢？

**据说现在已经“挖完了”，是这样吗？**

不完全正确。比特币的总供应量固定为 **2100万枚** ，预计在 **2140年** 左右全部挖完。截至目前（假设为2025年6月），挖矿仍在进行中：
- 比特币每挖出一个区块，矿工都会获得 **区块奖励** 。2024年4月20日第四次减半后，区块奖励为 **3.125 BTC** ，并每四年减半一次。
- 当前已开采的比特币约占总量的90%以上，但仍有少量新币通过挖矿逐步发行。

因此，比特币并未“挖完”，挖矿仍在持续，只是奖励逐渐减少。

**如果已经挖完了，那还如何保证新交易的正确性呢？**

即使未来所有比特币都被挖完（即区块奖励降至0），比特币网络的安全性和交易验证仍能得到保障，原因如下：
- **交易费的激励**
  用户在发起交易时可支付 **交易费** ，这笔费用归成功打包交易的矿工所有。随着区块奖励减少，交易费将成为矿工的主要收入来源。矿工仍有经济动力继续参与挖矿，验证交易并维护区块链。
- **工作量证明的持续性**
  挖矿的核心是 **工作量证明** ，它确保新区块的生成需要大量计算资源。即使没有新币奖励，矿工通过交易费仍会竞争记账权，保持网络的去中心化共识。
- **网络安全性**
  只要诚实矿工控制网络中超过50%的算力，区块链就难以被篡改。交易费机制确保了这种算力投入的可持续性。

换句话说，比特币的设计早已考虑了“挖完”后的场景，通过将矿工的奖励从区块奖励逐步过渡到交易费，保证了新交易的正确性和网络的长期运行。
